image: docker:19.03.6

stages:
- pre-build
- build
- test
- deploy

build-docker:
  services:
    - name: docker:19.03.6-dind
      entrypoint: ["env", "-u", "DOCKER_HOST"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ''
  
  
  before_script:
  - docker info
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD

  stage: pre-build
  script:
  - docker build -t minha-imagem .
  - docker tag minha-imagem jonilsonds9/minha-imagem:latest
  - docker push jonilsonds9/minha-imagem:latest

build-project:
  services:
  - docker:19.03.6-dind
  - mysql:5.7
  variables:
    MYSQL_USER: 'devops_dev'
    MYSQL_PASSWORD: 'mestre'
    MYSQL_DATABASE: 'todo_dev'
    MYSQL_ROOT_PASSWORD: 'senha'

    DB_NAME: 'todo_dev'
    DB_USER: 'devops_dev'
    DB_PASSWORD: 'mestre'
    DB_PORT: '3306'
    SECRET_KEY: 'r*5ltfzw-61ksdm41fuul8+hxs$86yo9%k1%k=(!@=-wv4qtyv'

  stage: build
  tags:
  - executor-tarefas
  dependencies:
  - build-docker
  script:
  - python manage.py makemigrations
  - python manage.py migrate